#/bin/bash
#Color
RED='\033[0;31m'
NC='\033[0m'
GREEN='\033[0;32m'
ORANGE='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
LIGHT='\033[0;37m'
rm -rf /usr/local/etc/xray/config.json
clear
echo -e "${ORANGE} ===================================="
echo -e "${ORANGE}       Xray installation process     "
echo -e "${ORANGE} ===================================="
echo -e "${GREEN}Starting the Xray setup script..."
echo -e "${GREEN}Installing the setup packages..."
echo -e "${GREEN}Checking for initial setup..."
XRAY=/etc/systemd/system/xray.service
if [ -f "$XRAY" ]
then
  echo -e "${LIGHT}!!ERROR!! Xray has been installed !!"
	echo ""
	echo -e "${RED}Uninstalling Xray...."
	sleep 3
	systemctl disable xray
	rm -rf /usr/local/etc/xray
	rm -rf /etc/systemd/system/xray.service
	rm -rf /etc/systemd/system/xray.service.d
	rm -rf /etc/systemd/system/xray@.service
	rm -rf /etc/systemd/system/xray@.service.d
	rm -rf /etc/systemd/system/multi-user.target.wants/xray.service
	rm -rf /etc/systemd/system/xray.service.d/10-donot_touch_single_conf.conf
	rm -rf /etc/systemd/system/xray@.service.d/10-donot_touch_single_conf.conf
	rm -rf /root/xray.crt
	rm -rf /root/xray.key
	rm -rf /usr/local/bin/xray
	rm -rf /usr/local/etc/xray
	rm -rf /usr/local/etc/xray/config.json
	rm -rf usr/local/share/xray
	rm -rf /usr/local/share/xray/geoip.dat
	rm -rf usr/local/share/xray/geosite.dat
	rm -rf /var/log/xray
	rm -rf /var/log/xray/access.log
	rm -rf /var/log/xray/error.log
	clear
	echo -e "${RED}Uninstalled Xray!"
  ./setup
else
  apt-get update -y >> /dev/null
  apt-get install -y net-tools >> /dev/null
  apt-get install -y curl >> /dev/null
  apt-get install -y neofetch >> /dev/null
  apt-get install -y mlocate >> /dev/null
  apt-get install -y ncdu >> /dev/null
  apt-get install -y socat >> /dev/null
  apt-get install -y  ca-certificates >> /dev/null
  apt-get install -y vnstat >> /dev/null
  clear
  echo -e "${GREEN}Configuring profile for alias PORTS..."
  sleep 3
  echo "alias ports='netstat -tulpn | grep LISTEN'" >> .profile
  service vnstat restart
  clear
  source .profile
  echo -e "\e[1;33m
  ░█▀▀▀█ ░█▀▀█ ░█▀▀█ ▀█▀ ░█▀▀█ ▀▀█▀▀ 　 ░█▀▀█ ░█──░█ 　 ░█▀▀▀ ▀█▀ ░█▀▀█ ─█▀▀█ ▀█▀ 
  ─▀▀▀▄▄ ░█─── ░█▄▄▀ ░█─ ░█▄▄█ ─░█── 　 ░█▀▀▄ ░█▄▄▄█ 　 ░█▀▀▀ ░█─ ░█─░█ ░█▄▄█ ░█─ 
  ░█▄▄▄█ ░█▄▄█ ░█─░█ ▄█▄ ░█─── ─░█── 　 ░█▄▄█ ──░█── 　 ░█─── ▄█▄ ─▀▀█▄ ░█─░█ ▄█▄\e[0m"
  echo ""
  echo "" 
  echo -e "Do you want to install XRAY (trojanGRPC and trojanTCP)(y/n)?"
  echo ""
  read ans
if [ $ans == "y" ]; 
then
    echo -e "Enter your domain name(Ex:something.com)?"
    echo -n "Domain name: "
    read domain 
    clear
    echo -e "Generating cert for Xray...."
    wget -O acme.sh https://raw.githubusercontent.com/acmesh-official/acme.sh/master/acme.sh
    bash acme.sh --install
    rm acme.sh
    cd .acme.sh
    bash acme.sh --register-account -m mymail@gmail.com
    bash acme.sh --issue --standalone -d $domain --force
    bash acme.sh --installcert -d $domain --fullchainpath /root/xray.crt --keypath /root/xray.key
    clear
    echo -e "${GREEN}Installing Xray.."
    rm -rf /usr/local/etc/xray/config.json
		bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install -u root
		echo -e '
{ "log": 
	{ "loglevel": "warning"
    },
    "inbounds": [ { "port": 443, "protocol": 
            "trojan", "settings": {
                "clients": [ { 
                        "password":"trojanaku", 
                        "email": 
                        "love@example.com"
                    }
                ]
            },
            "streamSettings": { "network": 
                "tcp", "security": "tls", 
                "tlsSettings": {
                    "alpn": [ "http/1.1" ], 
                    "certificates": [
                        { "certificateFile": 
                            "/root/xray.crt", 
                            "keyFile": 
                            "/root/xray.key"
                        }
                    ]
                }
            }
        },
		{ "port": 8000, "protocol": 
            "trojan", "settings": {
                "clients": [ { 
                        "password":"trojanaku", 
                        "email": 
                        "love@example.com"
                    }
                ]
            },
            "streamSettings": { "network": 
                "gun", "security": "tls", 
                "tlsSettings": {
                    "alpn": [ "http/1.1" ], 
                    "certificates": [
                        { "certificateFile": 
                            "/root/xray.crt", 
                            "keyFile": 
                            "/root/xray.key"
                        }
                    ]
                },
				"grpcSettings": 
				{
                    "serviceName": 
                    "GunService"
                }
            }
        }
    ], "outbounds": [ { "protocol": 
      "freedom", "settings": {}
    },
    { "protocol": "blackhole", "settings": 
      {}, "tag": "blocked"
    }
  ], "routing": { "rules": [ { "type": 
        "field", "ip": [
          "0.0.0.0/8", "10.0.0.0/8", 
          "100.64.0.0/10", "169.254.0.0/16", 
          "172.16.0.0/12", "192.0.0.0/24", 
          "192.0.2.0/24", "192.168.0.0/16", 
          "198.18.0.0/15", "198.51.100.0/24", 
          "203.0.113.0/24", "::1/128", 
          "fc00::/7", "fe80::/10"
        ], "outboundTag": "blocked"
      },
      { "inboundTag": [ "api" ], 
        "outboundTag": "api", "type": "field"
      },
      { "type": "field", "outboundTag": 
        "blocked", "protocol": [
          "bittorrent" ]
      }
    ]
  },
  "stats": {}, "api": { "services": [ 
      "StatsService"
    ], "tag": "api"
  },
  "policy": { "levels": { "0": { 
        "statsUserDownlink": true, 
        "statsUserUplink": true
      }
    },
    "system": { "statsInboundUplink": true, 
      "statsInboundDownlink": true
    }
  }
}
' >> /usr/local/etc/xray/config.json
		systemctl restart xray
		clear
		myip=$(curl -s icanhazip.com);
		echo -e " "| tee -a /root/log-install.txt
		echo -e "${LIGHT}============================================================================" | tee -a /root/log-install.txt
		echo -e "${ORANGE}                         !! INSTALLATION COMPLETED !!!                         " | tee -a /root/log-install.txt
		echo -e "${LIGHT}----------------------------------------------------------------------------" | tee -a /root/log-install.txt
		echo -e "" | tee -a /root/log-install.txt
		echo -e "${PURPLE}>>> Trojan Links and Port                                  " | tee -a /root/log-install.txt
		echo -e "${LIGHT}- TrojanGRPC(8000):                                       " | tee -a /root/log-install.txt
    echo -e "" | tee -a /root/log-install.txt
		echo -e "   trojan://trojanaku@$myip:8000?                       " | tee -a /root/log-install.txt      
    echo -e "   mode=gun&security=tls&type=grpc&serviceName=GunService    " | tee -a /root/log-install.txt
    echo -e "   &sni=ulist.com.my#TrojanGRPC                              " | tee -a /root/log-install.txt
    echo -e "" | tee -a /root/log-install.txt
		echo -e "${LIGHT}- TrojanTCP(443)  :                                       " | tee -a /root/log-install.txt
		echo -e "" | tee -a /root/log-install.txt
		echo -e "   trojan://trojanaku@$myip:443?                        " | tee -a /root/log-install.txt
		echo -e "   security=tls&headerType=none&type=tcp                     " | tee -a /root/log-install.txt          
		echo -e "   &sni=ulist.com.my#TrojanTCP                               " | tee -a /root/log-install.txt
		echo -e "" | tee -a /root/log-install.txt
		echo -e "${LIGHT}THIS INSTALLATION LOG WILL BE SAVED AT /root/"
fi
else
    echo -e "${RED}Installation has been cancelled!!"
    sleep 3
    clear
fi


